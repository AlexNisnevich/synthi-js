<html>
<head>
  <!-- This includes Flocking and all its dependencies, including jQuery 2.1.3 and Infusion -->
  <script src="lib/flocking/dist/flocking-all.js"></script>
  <script src="lib/jQuery-Knob/dist/jquery.knob.min.js"></script>

  <script>
    function Float32Concat(first, second) {
      var firstLength = first.length,
          result = new Float32Array(firstLength + second.length);

      result.set(first);
      result.set(second, firstLength);

      return result;
    }

    function Float32Interpolate(first, second, delta) {
      var result = new Float32Array(Math.min(first.length, second.length));
      for (var i=result.length; i-->0;) {
        result[i] = first[i] * delta + second[i] * (1 - delta);
      }
      return result;
    }

    var environment = flock.init();

    var tables = {
      // ramp = backwards sawtooth
      ramp: flock.fillTable(64, flock.tableGenerators.saw).map(function (x) {return -x;}),
      
      sin: function (shape) {
        if (shape >= 5) {
          // 10 = full positive rectification
          var rectification = (shape - 5) / 5;
          return flock.fillTable(64, flock.tableGenerators.sin).map(function (x) {
            return x * (1 - rectification) + (Math.abs(x)) * rectification;
          });
        } else {
          // 0 = full negative rectification
          var rectification = (5 - shape) / 5;
          return flock.fillTable(64, flock.tableGenerators.sin).map(function (x) {
            return x * (1 - rectification) + (-Math.abs(x)) * rectification;
          });
        }
      },
      
      square: function (shape) {
        // pulse width modulation (5 = normal square wave)

        var posLength = Math.floor(64 * shape / 10);
        var negLength = 64 - posLength;

        var posValues = flock.fillTable(posLength * 2, flock.tableGenerators.saw).filter(function (x) {return x > 0});
        var negValues = flock.fillTable(negLength * 2, flock.tableGenerators.saw).filter(function (x) {return x < 0});

        return Float32Concat(posValues, negValues);
      },

      triangle: function (shape) {
        var baseTriangle = flock.fillTable(64, flock.tableGenerators.tri);

        if (shape >= 5) {
          // 10 = only increasing section
          var increasingTriangle = Float32Concat(
            flock.fillTable(128, flock.tableGenerators.tri).slice(0,32),
            flock.fillTable(128, flock.tableGenerators.tri).slice(96,128)
          );
          return Float32Interpolate(increasingTriangle, baseTriangle, (shape - 5) / 5);
        } else {
          // 0 = only decreasing section
          var decreasingTriangle = flock.fillTable(128, flock.tableGenerators.tri).slice(32,96);
          return Float32Interpolate(decreasingTriangle, baseTriangle, (5 - shape) / 5);
        }
      }
    }

    var pin1sin = flock.synth({
      synthDef: {
        id: "pin1sin",
        ugen: "flock.ugen.sinOsc",
        freq: 440,
        mul: 0.1
      }
    });

    var pin1ramp = flock.synth({
      synthDef: {
        id: "pin1ramp",
        ugen: "flock.ugen.osc",
        table: tables.ramp,
        freq: 440,
        mul: 0.1,
        options: {
            interpolation: "linear"
        }
      }
    });

    var pin2square = flock.synth({
      synthDef: {
        id: "pin2square",
        ugen: "flock.ugen.squareOsc",
        freq: 440,
        mul: 0.1
      }
    });

    var pin2triangle = flock.synth({
      synthDef: {
        id: "pin2triangle",
        ugen: "flock.ugen.triOsc",
        freq: 440,
        mul: 0.1
      }
    });

    environment.start();

    $(function () {
      $(".dialOsc1Freq").knob({
        'change': function (v) { 
          pin1sin.set("pin1sin.freq", v); 
          pin1ramp.set("pin1ramp.freq", v); 
        }
      });

      $(".dialOsc1Shape").knob({
        'change': function (v) { pin1sin.set("pin1sin.table", tables.sin(v)); }
      });

      $(".dialOsc1SinLevel").knob({
        'change': function (v) { pin1sin.set("pin1sin.mul", v / 10); }
      });

      $(".dialOsc1RampLevel").knob({
        'change': function (v) { pin1ramp.set("pin1ramp.mul", v / 10); }
      });

      $(".dialOsc2Freq").knob({
        'change': function (v) { 
          pin2square.set("pin2square.freq", v); 
          pin2triangle.set("pin2triangle.freq", v); 
        }
      });

      $(".dialOsc2Shape").knob({
        'change': function (v) { 
          pin2square.set("pin2square.table", tables.square(v));
          pin2triangle.set("pin2triangle.table", tables.triangle(v));
        }
      });

      $(".dialOsc2SquareLevel").knob({
        'change': function (v) { pin2square.set("pin2square.mul", v / 10); }
      });

      $(".dialOsc2TriangleLevel").knob({
        'change': function (v) { pin2triangle.set("pin2triangle.mul", v / 10); }
      });
    })
  </script>
</head>
<body>
  <div id="oscillator1">
    <input type="text" value="440" class="dialOsc1Freq" data-min="40" data-max="10000">
    <input type="text" value="5" class="dialOsc1Shape" data-min="0" data-max="10">
    <input type="text" value="1" class="dialOsc1SinLevel" data-min="0" data-max="10">
    <input type="text" value="1" class="dialOsc1RampLevel" data-min="0" data-max="10">
  </div>
  <div id="oscillator1">
    <input type="text" value="440" class="dialOsc2Freq" data-min="40" data-max="10000">
    <input type="text" value="5" class="dialOsc2Shape" data-min="0" data-max="10">
    <input type="text" value="1" class="dialOsc2SquareLevel" data-min="0" data-max="10">
    <input type="text" value="1" class="dialOsc2TriangleLevel" data-min="0" data-max="10">
  </div>
</body>
</html>